<script>
    let map;

    function updateStatus(message, isError = false) {
        const statusDiv = document.getElementById('status');
        console.log(message);
        statusDiv.innerHTML = message;
        if (isError) {
            statusDiv.className = 'status error';
        } else {
            statusDiv.className = 'status';
        }
    }

    function initMap() {
        updateStatus('ğŸ—ºï¸ æ­£åœ¨åˆå§‹åŒ–åœ°å›¾...');

        try {
            // åˆ›å»ºåœ°å›¾å®ä¾‹
            map = L.map('map').setView([39.9042, 116.4074], 13);

            // æ·»åŠ OpenStreetMapå›¾å±‚
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // æ·»åŠ æ¯”ä¾‹å°º
            L.control.scale().addTo(map);

            updateStatus('âœ… åŸºç¡€åœ°å›¾åŠ è½½æˆåŠŸï¼æ­£åœ¨åŠ è½½GPXè½¨è¿¹...');

            // åŠ è½½å¤šæ¡GPXæ–‡ä»¶
            loadGPXTracks();

        } catch (error) {
            updateStatus('âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥: ' + error.message, true);
            console.error('Map initialization error:', error);
        }
    }

    function loadGPXTracks() {
        // è¿™é‡Œæ”¾å¤šæ¡GPXæ–‡ä»¶è·¯å¾„
        const gpxUrls = [
            'https://zhucy-99.github.io/academicpage/gpx/20241201not_outdoor_run_class_0.gpx',
            'https://zhucy-99.github.io/academicpage/gpx/20250124not_outdoor_run_class_0.gpx',
            'https://zhucy-99.github.io/academicpage/gpx/20250130not_outdoor_run_class_0.gpx'
            // ä»¥åä½ å¯ä»¥åœ¨è¿™é‡Œç»§ç»­åŠ 
        ];

        gpxUrls.forEach((gpxUrl, index) => {
            try {
                const gpx = new L.GPX(gpxUrl, {
                    async: true,
                    marker_options: {
                        startIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-green.png',
                        endIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                    },
                    polyline_options: {
                        color: ['#e74c3c', '#3498db', '#2ecc71', '#9b59b6'][index % 4], // å¤šæ¡è½¨è¿¹ä¸åŒé¢œè‰²
                        weight: 4,
                        opacity: 0.8,
                        smoothFactor: 1.0
                    }
                });

                gpx.on('loaded', function(e) {
                    updateStatus('ğŸ‰ GPXè½¨è¿¹åŠ è½½æˆåŠŸï¼');
                    
                    // åªå±•ç¤ºç¬¬ä¸€æ¡çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå¦åˆ™ä¼šè¦†ç›–ï¼‰
                    if (index === 0) {
                        const distance = (this.get_distance() / 1000).toFixed(2);
                        const duration = this.get_duration_string();
                        const elevationGain = this.get_elevation_gain().toFixed(0);
                        const elevationMax = this.get_elevation_max().toFixed(0);
                        const elevationMin = this.get_elevation_min().toFixed(0);
                        const startTime = this.get_start_time();
                        const endTime = this.get_end_time();
                        const avgPace = distance > 0 ? (this.get_duration() / 60 / parseFloat(distance)).toFixed(2) : 'æœªçŸ¥';

                        document.getElementById('gpx-details').innerHTML = `
                            <div class="gpx-details">
                                <div class="detail-item"><strong>ğŸ“ æ€»è·ç¦»</strong><br>${distance} å…¬é‡Œ</div>
                                <div class="detail-item"><strong>â±ï¸ æ€»æ—¶é—´</strong><br>${duration}</div>
                                <div class="detail-item"><strong>âš¡ å¹³å‡é…é€Ÿ</strong><br>${avgPace} åˆ†é’Ÿ/å…¬é‡Œ</div>
                                <div class="detail-item"><strong>ğŸ“ˆ ç´¯è®¡çˆ¬å‡</strong><br>${elevationGain} ç±³</div>
                                <div class="detail-item"><strong>ğŸ”ï¸ æœ€é«˜æµ·æ‹”</strong><br>${elevationMax} ç±³</div>
                                <div class="detail-item"><strong>ğŸï¸ æœ€ä½æµ·æ‹”</strong><br>${elevationMin} ç±³</div>
                            </div>
                            <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 5px;">
                                <strong>ğŸ• æ´»åŠ¨æ—¶é—´:</strong><br>
                                å¼€å§‹: ${startTime ? new Date(startTime).toLocaleString('zh-CN') : 'æœªè®°å½•'}<br>
                                ç»“æŸ: ${endTime ? new Date(endTime).toLocaleString('zh-CN') : 'æœªè®°å½•'}
                            </div>
                        `;
                    }

                    // è°ƒæ•´åœ°å›¾è§†å›¾ä»¥åŒ…å«è½¨è¿¹
                    map.fitBounds(e.target.getBounds(), {
                        padding: [20, 20]
                    });

                    this.bindPopup(`<div style="text-align: center; min-width: 200px;">
                        <h4 style="margin: 0 0 10px 0;">ğŸƒâ€â™‚ï¸ è½¨è¿¹ ${index + 1}</h4>
                        <p><strong>è·ç¦»:</strong> ${(this.get_distance() / 1000).toFixed(2)} km</p>
                        <p><strong>ç”¨æ—¶:</strong> ${this.get_duration_string()}</p>
                    </div>`);
                });

                gpx.on('error', function(e) {
                    updateStatus('âŒ GPXæ–‡ä»¶åŠ è½½å¤±è´¥: ' + gpxUrl, true);
                    console.error('GPX loading error:', e);
                });

                gpx.addTo(map);
            } catch (error) {
                updateStatus('âŒ GPXå¤„ç†å‡ºé”™: ' + error.message, true);
                console.error('GPX processing error:', error);
            }
        });
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åœ°å›¾
    window.addEventListener('load', function() {
        setTimeout(initMap, 500);
    });
</script>
