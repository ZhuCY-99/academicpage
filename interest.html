<script>
    let map;

    function updateStatus(message, isError = false) {
        const statusDiv = document.getElementById('status');
        console.log(message);
        statusDiv.innerHTML = message;
        if (isError) {
            statusDiv.className = 'status error';
        } else {
            statusDiv.className = 'status';
        }
    }

    function initMap() {
        updateStatus('🗺️ 正在初始化地图...');

        try {
            // 创建地图实例
            map = L.map('map').setView([39.9042, 116.4074], 13);

            // 添加OpenStreetMap图层
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // 添加比例尺
            L.control.scale().addTo(map);

            updateStatus('✅ 基础地图加载成功！正在加载GPX轨迹...');

            // 加载多条GPX文件
            loadGPXTracks();

        } catch (error) {
            updateStatus('❌ 地图初始化失败: ' + error.message, true);
            console.error('Map initialization error:', error);
        }
    }

    function loadGPXTracks() {
        // 这里放多条GPX文件路径
        const gpxUrls = [
            'https://zhucy-99.github.io/academicpage/gpx/20241201not_outdoor_run_class_0.gpx',
            'https://zhucy-99.github.io/academicpage/gpx/20250124not_outdoor_run_class_0.gpx',
            'https://zhucy-99.github.io/academicpage/gpx/20250130not_outdoor_run_class_0.gpx'
            // 以后你可以在这里继续加
        ];

        gpxUrls.forEach((gpxUrl, index) => {
            try {
                const gpx = new L.GPX(gpxUrl, {
                    async: true,
                    marker_options: {
                        startIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-green.png',
                        endIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                    },
                    polyline_options: {
                        color: ['#e74c3c', '#3498db', '#2ecc71', '#9b59b6'][index % 4], // 多条轨迹不同颜色
                        weight: 4,
                        opacity: 0.8,
                        smoothFactor: 1.0
                    }
                });

                gpx.on('loaded', function(e) {
                    updateStatus('🎉 GPX轨迹加载成功！');
                    
                    // 只展示第一条的详细信息（否则会覆盖）
                    if (index === 0) {
                        const distance = (this.get_distance() / 1000).toFixed(2);
                        const duration = this.get_duration_string();
                        const elevationGain = this.get_elevation_gain().toFixed(0);
                        const elevationMax = this.get_elevation_max().toFixed(0);
                        const elevationMin = this.get_elevation_min().toFixed(0);
                        const startTime = this.get_start_time();
                        const endTime = this.get_end_time();
                        const avgPace = distance > 0 ? (this.get_duration() / 60 / parseFloat(distance)).toFixed(2) : '未知';

                        document.getElementById('gpx-details').innerHTML = `
                            <div class="gpx-details">
                                <div class="detail-item"><strong>📏 总距离</strong><br>${distance} 公里</div>
                                <div class="detail-item"><strong>⏱️ 总时间</strong><br>${duration}</div>
                                <div class="detail-item"><strong>⚡ 平均配速</strong><br>${avgPace} 分钟/公里</div>
                                <div class="detail-item"><strong>📈 累计爬升</strong><br>${elevationGain} 米</div>
                                <div class="detail-item"><strong>🏔️ 最高海拔</strong><br>${elevationMax} 米</div>
                                <div class="detail-item"><strong>🏞️ 最低海拔</strong><br>${elevationMin} 米</div>
                            </div>
                            <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 5px;">
                                <strong>🕐 活动时间:</strong><br>
                                开始: ${startTime ? new Date(startTime).toLocaleString('zh-CN') : '未记录'}<br>
                                结束: ${endTime ? new Date(endTime).toLocaleString('zh-CN') : '未记录'}
                            </div>
                        `;
                    }

                    // 调整地图视图以包含轨迹
                    map.fitBounds(e.target.getBounds(), {
                        padding: [20, 20]
                    });

                    this.bindPopup(`<div style="text-align: center; min-width: 200px;">
                        <h4 style="margin: 0 0 10px 0;">🏃‍♂️ 轨迹 ${index + 1}</h4>
                        <p><strong>距离:</strong> ${(this.get_distance() / 1000).toFixed(2)} km</p>
                        <p><strong>用时:</strong> ${this.get_duration_string()}</p>
                    </div>`);
                });

                gpx.on('error', function(e) {
                    updateStatus('❌ GPX文件加载失败: ' + gpxUrl, true);
                    console.error('GPX loading error:', e);
                });

                gpx.addTo(map);
            } catch (error) {
                updateStatus('❌ GPX处理出错: ' + error.message, true);
                console.error('GPX processing error:', error);
            }
        });
    }

    // 页面加载完成后初始化地图
    window.addEventListener('load', function() {
        setTimeout(initMap, 500);
    });
</script>
