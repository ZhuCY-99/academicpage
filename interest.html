<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æˆ·å¤–è½¨è¿¹é›†åˆ - Auto Scan Version</title>
    
    <!-- å¼•å…¥Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        .back-link {
            display: inline-block;
            margin: 15px 0;
            padding: 12px 24px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: background 0.3s;
            font-weight: 500;
        }
        
        .back-link:hover {
            background: #2980b9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .map-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        #map {
            height: 650px;
            width: 100%;
        }
        
        .controls h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .scan-section {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6c3;
        }
        
        .scan-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            resize: vertical;
            min-height: 100px;
        }
        
        .scan-button {
            width: 100%;
            padding: 10px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: 500;
        }
        
        .scan-button:hover {
            background: #229954;
        }
        
        .scan-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .control-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .show-all { background: #27ae60; color: white; }
        .hide-all { background: #e74c3c; color: white; }
        .fit-bounds { background: #f39c12; color: white; }
        .reload-btn { background: #9b59b6; color: white; }
        
        .control-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        .status {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-weight: 500;
            background: #e8f4fd;
            color: #2980b9;
            border: 1px solid #bde4f4;
        }
        
        .status.error {
            background: #fdf2f2;
            color: #e74c3c;
            border-color: #fecaca;
        }
        
        .status.success {
            background: #f0fff4;
            color: #16a085;
            border-color: #a7f3d0;
        }
        
        .status.warning {
            background: #fffbf0;
            color: #d68910;
            border-color: #f7dc6f;
        }
        
        .track-list {
            max-height: 450px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
        }
        
        .track-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 6px 0;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .track-item:hover {
            background: #e9ecef;
            transform: translateX(3px);
        }
        
        .track-item.loading {
            opacity: 0.7;
            border-left-color: #ffc107;
            animation: pulse 1.5s ease-in-out infinite alternate;
        }
        
        .track-item.loaded {
            border-left-color: #28a745;
        }
        
        .track-item.error {
            border-left-color: #dc3545;
            opacity: 0.6;
        }
        
        @keyframes pulse {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }
        
        .track-checkbox {
            margin-right: 12px;
            transform: scale(1.1);
        }
        
        .track-info {
            flex: 1;
        }
        
        .track-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
            font-size: 0.95em;
        }
        
        .track-details {
            font-size: 0.8em;
            color: #6c757d;
            line-height: 1.3;
        }
        
        .color-legend {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .legend-gradient {
            height: 20px;
            background: linear-gradient(90deg, #2ecc71, #f1c40f, #e67e22, #e74c3c, #8b0000);
            border-radius: 4px;
            margin: 8px 0;
        }
        
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #666;
        }
        
        .summary-stats {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        
        .summary-stats h4 {
            margin: 0 0 10px 0;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 4px;
        }
        
        .help-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
                order: 2;
            }
            
            .map-container {
                order: 1;
            }
            
            #map {
                height: 500px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .control-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ—ºï¸ æˆ‘çš„æˆ·å¤–è½¨è¿¹é›†åˆ</h1>
        <p>è‡ªåŠ¨æ‰«æå¹¶å¯è§†åŒ–æ‰€æœ‰GPXè½¨è¿¹æ–‡ä»¶</p>
        <a href="https://zhucy-99.github.io/academicpage/" class="back-link">â† è¿”å›ä¸»é¡µ</a>
    </div>
    
    <div class="main-content">
        <div class="sidebar">
            <div class="controls">
                <h3>ğŸ” æ–‡ä»¶æ‰«æ</h3>
                
                <div class="scan-section">
                    <label for="file-list" style="font-weight: 500; color: #2c3e50;">GPXæ–‡ä»¶åˆ—è¡¨ï¼š</label>
                    <textarea id="file-list" class="scan-input" placeholder="åœ¨è¿™é‡Œç²˜è´´GPXæ–‡ä»¶ååˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªæ–‡ä»¶åã€‚&#10;ä¾‹å¦‚ï¼š&#10;20241201not_outdoor_run_class_0.gpx&#10;20241202morning_run.gpx&#10;20241203evening_cycle.gpx&#10;&#10;æˆ–è€…ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®è‡ªåŠ¨å°è¯•å¸¸è§æ–‡ä»¶å..."></textarea>
                    <button id="scan-button" class="scan-button">ğŸš€ åŠ è½½è½¨è¿¹æ–‡ä»¶</button>
                    <button id="auto-scan-button" class="scan-button" style="background: #e67e22; margin-top: 5px;">ğŸ¯ æ™ºèƒ½æ‰«æå¸¸è§æ–‡ä»¶å</button>
                    
                    <div class="help-text">
                        <strong>ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</strong><br>
                        â€¢ å¯ä»¥æ‰‹åŠ¨è¾“å…¥æ–‡ä»¶åï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ™ºèƒ½æ‰«æ<br>
                        â€¢ æ™ºèƒ½æ‰«æä¼šå°è¯•å¸¸è§çš„æ–‡ä»¶å‘½åæ¨¡å¼<br>
                        â€¢ æ–‡ä»¶åéœ€è¦åŒ…å« .gpx åç¼€
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button class="control-btn show-all" onclick="showAllTracks()">æ˜¾ç¤ºå…¨éƒ¨</button>
                    <button class="control-btn hide-all" onclick="hideAllTracks()">éšè—å…¨éƒ¨</button>
                    <button class="control-btn fit-bounds" onclick="fitAllBounds()">é€‚åº”è§†å›¾</button>
                    <button class="control-btn reload-btn" onclick="clearAndReload()">é‡æ–°æ‰«æ</button>
                </div>
                
                <div class="status" id="status">ç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®å¼€å§‹åŠ è½½è½¨è¿¹</div>
                
                <div class="track-list" id="track-list">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        ğŸ“ æš‚æ— è½¨è¿¹æ–‡ä»¶<br>
                        è¯·å…ˆæ·»åŠ æ–‡ä»¶åå¹¶ç‚¹å‡»åŠ è½½
                    </div>
                </div>
                
                <div class="color-legend" style="display: none;" id="color-legend">
                    <div class="legend-title">ğŸ¨ è·ç¦»é…è‰²è¯´æ˜</div>
                    <div class="legend-gradient"></div>
                    <div class="legend-labels">
                        <span>çŸ­</span>
                        <span>ä¸­ç­‰</span>
                        <span>è¾ƒé•¿</span>
                        <span>é•¿</span>
                        <span>è¶…é•¿</span>
                    </div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        è½¨è¿¹æŒ‰è·ç¦»è‡ªåŠ¨é…è‰²ï¼Œçº¢è‰²è¡¨ç¤ºæ›´é•¿è·ç¦»
                    </div>
                </div>
                
                <div class="summary-stats" id="summary-stats" style="display: none;">
                    <h4>ğŸ“Š ç»Ÿè®¡æ±‡æ€»</h4>
                    <div class="stats-grid" id="stats-content"></div>
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>
    
    <!-- å¼•å…¥Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- å¼•å…¥GPXæ’ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let map;
        let trackLayers = [];
        let allBounds = null;
        let loadedTracksCount = 0;
        let totalStats = {
            distance: 0,
            duration: 0,
            elevationGain: 0,
            tracksCount: 0
        };
        let currentGPXFiles = [];
        
        // å¸¸è§çš„GPXæ–‡ä»¶åæ¨¡å¼
        const COMMON_PATTERNS = [
            // æ—¥æœŸæ ¼å¼çš„æ–‡ä»¶å
            ...generateDatePatterns(),
            // å¸¸è§çš„è¿åŠ¨ç±»å‹æ–‡ä»¶å
            'morning_run.gpx', 'evening_run.gpx', 'weekend_run.gpx',
            'cycling.gpx', 'bike_ride.gpx', 'cycling_route.gpx',
            'hiking.gpx', 'hike.gpx', 'mountain_hike.gpx',
            'walking.gpx', 'walk.gpx', 'daily_walk.gpx',
            // å¸¦ç¼–å·çš„æ–‡ä»¶å
            ...Array.from({length: 20}, (_, i) => `track_${i + 1}.gpx`),
            ...Array.from({length: 10}, (_, i) => `route_${i + 1}.gpx`),
            ...Array.from({length: 10}, (_, i) => `activity_${i + 1}.gpx`),
            // Stravaç­‰åº”ç”¨å¸¸è§æ ¼å¼
            ...Array.from({length: 10}, (_, i) => `Activity_${Date.now() - i * 86400000}.gpx`),
        ];
        
        // ç”Ÿæˆæ—¥æœŸæ¨¡å¼çš„æ–‡ä»¶åï¼ˆæœ€è¿‘3ä¸ªæœˆï¼‰
        function generateDatePatterns() {
            const patterns = [];
            const today = new Date();
            
            for (let i = 0; i < 90; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                // å„ç§æ—¥æœŸæ ¼å¼
                patterns.push(`${year}${month}${day}_run.gpx`);
                patterns.push(`${year}${month}${day}_outdoor_run.gpx`);
                patterns.push(`${year}${month}${day}not_outdoor_run_class_0.gpx`);
                patterns.push(`${year}-${month}-${day}_activity.gpx`);
                patterns.push(`${year}_${month}_${day}.gpx`);
            }
            
            return patterns;
        }
        
        // æ ¹æ®è·ç¦»ç”Ÿæˆé¢œè‰²
        function getColorByDistance(distance, minDist, maxDist) {
            if (maxDist === minDist) return '#e74c3c';
            
            const normalized = (distance - minDist) / (maxDist - minDist);
            
            if (normalized < 0.25) {
                const t = normalized * 4;
                return `rgb(${Math.round(46 + t * (241-46))}, ${Math.round(204 + t * (196-204))}, 113)`;
            } else if (normalized < 0.5) {
                const t = (normalized - 0.25) * 4;
                return `rgb(${Math.round(241 + t * (230-241))}, ${Math.round(196 + t * (126-196))}, ${Math.round(113 + t * (34-113))})`;
            } else if (normalized < 0.75) {
                const t = (normalized - 0.5) * 4;
                return `rgb(${Math.round(230 + t * (231-230))}, ${Math.round(126 + t * (76-126))}, ${Math.round(34 + t * (60-34))})`;
            } else {
                const t = (normalized - 0.75) * 4;
                return `rgb(${Math.round(231 + t * (139-231))}, ${Math.round(76 * (1-t))}, ${Math.round(60 * (1-t))})`;
            }
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            console.log(message);
        }
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            try {
                // åˆ›å»ºåœ°å›¾å®ä¾‹
                map = L.map('map').setView([39.9042, 116.4074], 13);
                
                // æ·»åŠ å¤šä¸ªå›¾å±‚é€‰é¡¹
                const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Â© OpenStreetMap contributors'
                });
                
                const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles Â© Esri'
                });
                
                const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data: Â© OpenStreetMap contributors, SRTM | Map style: Â© OpenTopoMap'
                });
                
                // é»˜è®¤æ·»åŠ OSMå›¾å±‚
                osmLayer.addTo(map);
                
                // æ·»åŠ å›¾å±‚æ§åˆ¶
                L.control.layers({
                    "ğŸ—ºï¸ è¡—é“åœ°å›¾": osmLayer,
                    "ğŸ›°ï¸ å«æ˜Ÿåœ°å›¾": satelliteLayer,
                    "â›°ï¸ åœ°å½¢åœ°å›¾": topoLayer
                }).addTo(map);
                
                // æ·»åŠ æ¯”ä¾‹å°º
                L.control.scale().addTo(map);
                
                updateStatus('âœ… åœ°å›¾åˆå§‹åŒ–å®Œæˆï¼Œè¯·è¾“å…¥GPXæ–‡ä»¶åå¹¶å¼€å§‹åŠ è½½', 'success');
                
            } catch (error) {
                updateStatus(`âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                console.error('Map initialization error:', error);
            }
        }
        
        // è§£ææ–‡ä»¶ååˆ—è¡¨
        function parseFileList(text) {
            return text
                .split(/[\r\n]+/)
                .map(line => line.trim())
                .filter(line => line && line.endsWith('.gpx'))
                .map(line => line.replace(/^[â€¢\-\*]\s*/, '')); // ç§»é™¤å¯èƒ½çš„åˆ—è¡¨ç¬¦å·
        }
        
        // åŠ è½½GPXæ–‡ä»¶
        function loadGPXFiles(gpxFiles) {
            if (gpxFiles.length === 0) {
                updateStatus('âš ï¸ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„GPXæ–‡ä»¶å', 'warning');
                return;
            }
            
            currentGPXFiles = gpxFiles;
            updateStatus(`ğŸ“‚ å¼€å§‹åŠ è½½ ${gpxFiles.length} ä¸ªè½¨è¿¹æ–‡ä»¶...`);
            
            // é‡ç½®ç»Ÿè®¡
            totalStats = { distance: 0, duration: 0, elevationGain: 0, tracksCount: 0 };
            trackLayers = [];
            loadedTracksCount = 0;
            allBounds = null;
            
            // åˆ›å»ºè½¨è¿¹åˆ—è¡¨UI
            createTrackList(gpxFiles);
            
            // éšè—å›¾ä¾‹å’Œç»Ÿè®¡
            document.getElementById('color-legend').style.display = 'none';
            document.getElementById('summary-stats').style.display = 'none';
            
            // ç”¨äºè®¡ç®—è·ç¦»èŒƒå›´
            let tempDistances = [];
            let tempLoadedCount = 0;
            let validFilesCount = 0;
            
            // é¦–å…ˆå°è¯•åŠ è½½æ‰€æœ‰æ–‡ä»¶
            gpxFiles.forEach((filename, index) => {
                const gpxUrl = `https://zhucy-99.github.io/academicpage/gpx/${filename}`;
                
                const gpx = new L.GPX(gpxUrl, {
                    async: true,
                    marker_options: { startIconUrl: null, endIconUrl: null, shadowUrl: null },
                    polyline_options: { color: '#cccccc', weight: 3, opacity: 0.7 }
                });
                
                gpx.on('loaded', function(e) {
                    const distance = this.get_distance() / 1000;
                    tempDistances.push({ index, distance, gpx: this, filename });
                    tempLoadedCount++;
                    validFilesCount++;
                    
                    updateTrackItem(index, 'loading', `å·²åŠ è½½ - ${distance.toFixed(2)}km`);
                    
                    // å½“æ‰€æœ‰æœ‰æ•ˆæ–‡ä»¶éƒ½åŠ è½½å®Œæˆåï¼Œåº”ç”¨é…è‰²
                    if (tempLoadedCount === validFilesCount) {
                        setTimeout(() => applyColorsByDistance(tempDistances), 500);
                    }
                });
                
                gpx.on('error', function(e) {
                    console.warn(`Failed to load ${filename}:`, e);
                    updateTrackItem(index, 'error', 'æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•åŠ è½½');
                    tempLoadedCount++;
                    
                    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ–‡ä»¶éƒ½å·²å°è¯•åŠ è½½
                    if (tempLoadedCount === gpxFiles.length && validFilesCount > 0) {
                        setTimeout(() => applyColorsByDistance(tempDistances), 500);
                    } else if (tempLoadedCount === gpxFiles.length && validFilesCount === 0) {
                        updateStatus('âŒ æ²¡æœ‰æˆåŠŸåŠ è½½ä»»ä½•GPXæ–‡ä»¶', 'error');
                    }
                });
                
                trackLayers[index] = gpx;
                updateTrackItem(index, 'loading', 'æ­£åœ¨åŠ è½½...');
            });
            
            // è®¾ç½®è¶…æ—¶æ£€æŸ¥
            setTimeout(() => {
                if (validFilesCount === 0) {
                    updateStatus(`âš ï¸ å°è¯•äº† ${gpxFiles.length} ä¸ªæ–‡ä»¶ï¼Œä½†æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„GPXæ–‡ä»¶`, 'warning');
                }
            }, 10000);
        }
        
        // åº”ç”¨æŒ‰è·ç¦»é…è‰²
        function applyColorsByDistance(distanceData) {
            if (distanceData.length === 0) return;
            
            const distances = distanceData.map(d => d.distance);
            const minDist = Math.min(...distances);
            const maxDist = Math.max(...distances);
            
            updateStatus(`ğŸ¨ ä¸º ${distanceData.length} æ¡è½¨è¿¹åº”ç”¨é…è‰² (${minDist.toFixed(2)}-${maxDist.toFixed(2)}km)`);
            
            // æŒ‰è·ç¦»æ’åº
            distanceData.sort((a, b) => b.distance - a.distance);
            
            // é‡æ–°æ’åºè½¨è¿¹åˆ—è¡¨
            reorderTrackList(distanceData);
            
            allBounds = L.latLngBounds();
            
            distanceData.forEach(({ index, distance, gpx, filename }) => {
                const color = getColorByDistance(distance, minDist, maxDist);
                
                // æ›´æ–°æ ·å¼å¹¶æ·»åŠ åˆ°åœ°å›¾
                gpx.setStyle({ color: color, weight: 4, opacity: 0.8 });
                gpx.addTo(map);
                
                allBounds.extend(gpx.getBounds());
                
                // æ›´æ–°ç»Ÿè®¡
                const duration = gpx.get_duration();
                const elevationGain = gpx.get_elevation_gain();
                
                totalStats.distance += distance;
                totalStats.duration += duration;
                totalStats.elevationGain += elevationGain;
                totalStats.tracksCount++;
                
                // æ·»åŠ å¼¹çª—
                gpx.bindPopup(`
                    <div style="text-align: center; min-width: 220px;">
                        <h4 style="margin: 0 0 10px 0; color: ${color};">ğŸƒâ€â™‚ï¸ ${filename}</h4>
                        <p><strong>è·ç¦»:</strong> ${distance.toFixed(2)} km</p>
                        <p><strong>ç”¨æ—¶:</strong> ${gpx.get_duration_string()}</p>
                        <p><strong>çˆ¬å‡:</strong> ${elevationGain.toFixed(0)} m</p>
                        <p><strong>å¹³å‡é…é€Ÿ:</strong> ${duration > 0 && distance > 0 ? 
                            (duration / 60 / distance).toFixed(2) + ' min/km' : 'æœªçŸ¥'}</p>
                        <p style="font-size: 0.9em; color: #666;">ç‚¹å‡»è½¨è¿¹åç§°å¯å¿«é€Ÿå®šä½</p>
                    </div>
                `);
                
                // æ›´æ–°æ˜¾ç¤º
                const durationStr = gpx.get_duration_string();
                updateTrackItem(index, 'loaded', `${distance.toFixed(2)}km Â· ${durationStr}`, color);
                
                loadedTracksCount++;
            });
            
            // å®ŒæˆåŠ è½½
            finishLoading();
        }
        
        // åˆ›å»ºè½¨è¿¹åˆ—è¡¨UI
        function createTrackList(gpxFiles) {
            const trackList = document.getElementById('track-list');
            trackList.innerHTML = '';
            
            gpxFiles.forEach((filename, index) => {
                const trackItem = document.createElement('div');
                trackItem.className = 'track-item';
                trackItem.id = `track-${index}`;
                
                trackItem.innerHTML = `
                    <input type="checkbox" class="track-checkbox" checked data-index="${index}">
                    <div class="track-info">
                        <div class="track-name">${filename}</div>
                        <div class="track-details">å‡†å¤‡åŠ è½½...</div>
                    </div>
                `;
                
                // æ·»åŠ å¤é€‰æ¡†äº‹ä»¶
                const checkbox = trackItem.querySelector('.track-checkbox');
                checkbox.addEventListener('change', function() {
                    const idx = parseInt(this.dataset.index);
                    if (trackLayers[idx]) {
                        if (this.checked) {
                            map.addLayer(trackLayers[idx]);
                        } else {
                            map.removeLayer(trackLayers[idx]);
                        }
                    }
                });
                
                // æ·»åŠ ç‚¹å‡»ç¼©æ”¾äº‹ä»¶
                trackItem.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        const idx = parseInt(this.querySelector('.track-checkbox').dataset.index);
                        if (trackLayers[idx] && trackLayers[idx]._map) {
                            map.fitBounds(trackLayers[idx].getBounds(), {padding: [30, 30]});
                        }
                    }
                });
                
                trackList.appendChild(trackItem);
            });
        }
        
        // æ›´æ–°è½¨è¿¹é¡¹æ˜¾ç¤º
        function updateTrackItem(index, status, details, color = null) {
            const trackItem = document.getElementById(`track-${index}`);
            if (!trackItem) return;
            
            trackItem.className = `track-item ${status}`;
            
            if (color) {
                trackItem.style.borderLeftColor = color;
                const trackName = trackItem.querySelector('.track-name');
                trackName.style.color = color;
                trackName.style.fontWeight = '700';
            }
            
            trackItem.querySelector('.track-details').textContent = details;
        }
        
        // é‡æ–°æ’åºè½¨è¿¹åˆ—è¡¨
        function
