<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPX轨迹地图展示</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            margin: 0 0 10px 0;
        }
        
        .header p {
            color: #666;
            margin: 0;
        }
        
        .map-container {
            position: relative;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        #map {
            height: 600px;
            width: 100%;
        }
        
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-height: 300px;
            overflow-y: auto;
            min-width: 200px;
        }
        
        .controls h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
        }
        
        .track-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .track-checkbox {
            margin-right: 8px;
        }
        
        .track-color {
            width: 16px;
            height: 3px;
            margin-right: 8px;
            border-radius: 2px;
        }
        
        .track-name {
            flex: 1;
            color: #555;
            cursor: pointer;
        }
        
        .stats {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>GPX轨迹地图展示</h1>
        <p>展示gpx文件夹中的所有运动轨迹</p>
    </div>
    
    <div id="error-message" class="error" style="display: none;"></div>
    <div id="loading" class="loading">正在加载GPX文件...</div>
    
    <div class="map-container" style="display: none;" id="map-container">
        <div class="controls">
            <h3>轨迹列表</h3>
            <div id="track-list"></div>
        </div>
        <div id="map"></div>
    </div>
    
    <div class="stats" id="stats" style="display: none;">
        <div class="stat-card">
            <div class="stat-number" id="total-tracks">0</div>
            <div class="stat-label">总轨迹数</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="total-distance">0</div>
            <div class="stat-label">总距离 (km)</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="total-points">0</div>
            <div class="stat-label">总轨迹点</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        let map;
        let trackLayers = {};
        let trackColors = ['#FF5733', '#33FF57', '#3357FF', '#FF33F5', '#33FFF5', '#F533FF', '#57FF33', '#FF3357', '#5733FF', '#F5FF33'];
        let colorIndex = 0;
        let totalDistance = 0;
        let totalPoints = 0;

        // 初始化地图
        function initMap() {
            map = L.map('map').setView([39.9042, 116.4074], 10); // 默认北京坐标
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }

        // 解析GPX文件
        function parseGPX(gpxText, filename) {
            const parser = new DOMParser();
            const gpxDoc = parser.parseFromString(gpxText, 'text/xml');
            
            const tracks = [];
            const trkElements = gpxDoc.getElementsByTagName('trk');
            
            for (let i = 0; i < trkElements.length; i++) {
                const trksegs = trkElements[i].getElementsByTagName('trkseg');
                
                for (let j = 0; j < trksegs.length; j++) {
                    const points = [];
                    const trkpts = trksegs[j].getElementsByTagName('trkpt');
                    
                    for (let k = 0; k < trkpts.length; k++) {
                        const lat = parseFloat(trkpts[k].getAttribute('lat'));
                        const lon = parseFloat(trkpts[k].getAttribute('lon'));
                        
                        if (!isNaN(lat) && !isNaN(lon)) {
                            points.push([lat, lon]);
                        }
                    }
                    
                    if (points.length > 0) {
                        tracks.push({
                            name: filename,
                            points: points,
                            color: trackColors[colorIndex % trackColors.length]
                        });
                        colorIndex++;
                    }
                }
            }
            
            return tracks;
        }

        // 计算两点间距离（简单的球面距离公式）
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 地球半径（千米）
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // 计算轨迹总距离
        function calculateTrackDistance(points) {
            let distance = 0;
            for (let i = 1; i < points.length; i++) {
                distance += calculateDistance(
                    points[i-1][0], points[i-1][1],
                    points[i][0], points[i][1]
                );
            }
            return distance;
        }

        // 添加轨迹到地图
        function addTrackToMap(track) {
            const polyline = L.polyline(track.points, {
                color: track.color,
                weight: 3,
                opacity: 0.8
            }).addTo(map);

            const distance = calculateTrackDistance(track.points);
            totalDistance += distance;
            totalPoints += track.points.length;

            polyline.bindPopup(`
                <strong>${track.name}</strong><br>
                轨迹点数: ${track.points.length}<br>
                距离: ${distance.toFixed(2)} km
            `);

            trackLayers[track.name] = polyline;

            // 添加到控制面板
            const trackList = document.getElementById('track-list');
            const trackItem = document.createElement('div');
            trackItem.className = 'track-item';
            trackItem.innerHTML = `
                <input type="checkbox" class="track-checkbox" checked onchange="toggleTrack('${track.name}')">
                <div class="track-color" style="background-color: ${track.color}"></div>
                <div class="track-name" onclick="zoomToTrack('${track.name}')">${track.name}</div>
            `;
            trackList.appendChild(trackItem);
        }

        // 切换轨迹显示/隐藏
        function toggleTrack(trackName) {
            const layer = trackLayers[trackName];
            if (layer) {
                if (map.hasLayer(layer)) {
                    map.removeLayer(layer);
                } else {
                    map.addLayer(layer);
                }
            }
        }

        // 缩放到特定轨迹
        function zoomToTrack(trackName) {
            const layer = trackLayers[trackName];
            if (layer) {
                map.fitBounds(layer.getBounds());
                layer.openPopup();
            }
        }

        // 获取GPX文件列表
        async function getGPXFiles() {
            const commonFilenames = [
                '20241201not_outdoor_run_class_0.gpx',
                // 添加更多常见的GPX文件名模式
            ];
            
            const gpxFiles = [];
            
            // 尝试加载一些常见的文件名模式
            const patterns = [
                /\d{8}.*\.gpx$/,  // 日期开头的文件
            ];
            
            // 由于无法直接列出目录，我们尝试一些常见的命名模式
            const possibleFiles = [];
            for (let year = 2023; year <= 2025; year++) {
                for (let month = 1; month <= 12; month++) {
                    for (let day = 1; day <= 31; day++) {
                        const dateStr = `${year}${month.toString().padStart(2, '0')}${day.toString().padStart(2, '0')}`;
                        possibleFiles.push(`${dateStr}not_outdoor_run_class_0.gpx`);
                        possibleFiles.push(`${dateStr}_run.gpx`);
                        possibleFiles.push(`${dateStr}_walk.gpx`);
                        possibleFiles.push(`${dateStr}_bike.gpx`);
                        possibleFiles.push(`${dateStr}.gpx`);
                    }
                }
            }
            
            // 添加一些通用文件名
            possibleFiles.push(...commonFilenames);
            
            // 尝试加载这些文件
            const loadPromises = possibleFiles.map(async filename => {
                try {
                    const response = await fetch(`gpx/${filename}`);
                    if (response.ok) {
                        const gpxContent = await response.text();
                        return { filename, content: gpxContent };
                    }
                } catch (error) {
                    // 忽略404错误
                }
                return null;
            });
            
            const results = await Promise.all(loadPromises);
            return results.filter(result => result !== null);
        }

        // 主要的加载函数
        async function loadAllGPXFiles() {
            try {
                const gpxFiles = await getGPXFiles();
                
                if (gpxFiles.length === 0) {
                    document.getElementById('error-message').textContent = '未找到任何GPX文件。请确保文件放在gpx文件夹中。';
                    document.getElementById('error-message').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    return;
                }

                initMap();
                
                let allBounds = [];
                let trackCount = 0;

                for (const file of gpxFiles) {
                    const tracks = parseGPX(file.content, file.filename);
                    
                    for (const track of tracks) {
                        addTrackToMap(track);
                        allBounds = allBounds.concat(track.points);
                        trackCount++;
                    }
                }

                // 调整地图视图以显示所有轨迹
                if (allBounds.length > 0) {
                    const group = new L.featureGroup(Object.values(trackLayers));
                    map.fitBounds(group.getBounds().pad(0.1));
                }

                // 更新统计信息
                document.getElementById('total-tracks').textContent = trackCount;
                document.getElementById('total-distance').textContent = totalDistance.toFixed(2);
                document.getElementById('total-points').textContent = totalPoints;

                // 显示地图和统计
                document.getElementById('loading').style.display = 'none';
                document.getElementById('map-container').style.display = 'block';
                document.getElementById('stats').style.display = 'grid';

            } catch (error) {
                document.getElementById('error-message').textContent = '加载GPX文件时出错: ' + error.message;
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        // 页面加载完成后开始加载GPX文件
        document.addEventListener('DOMContentLoaded', loadAllGPXFiles);
    </script>
</body>
</html>
