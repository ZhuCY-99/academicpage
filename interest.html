<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æˆ·å¤–è½¨è¿¹ - My Interests</title>
    
    <!-- å¼•å…¥Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #fff;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        .map-container {
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        #map {
            height: 600px;
            width: 100%;
        }
        
        .info-panel {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }
        
        .status {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-item strong {
            color: #e74c3c;
            font-size: 1.2em;
        }
        
        .legend {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .color-bar {
            height: 20px;
            background: linear-gradient(90deg, 
                #2E86AB 0%, 
                #A23B72 25%, 
                #F18F01 50%, 
                #C73E1D 75%, 
                #8B0000 100%);
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .color-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
        }
        
        .back-link {
            display: inline-block;
            margin: 20px 0;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .back-link:hover {
            background: #2980b9;
        }
        
        .error {
            color: #e74c3c;
            background: #fdf2f2;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #fecaca;
            margin: 10px 0;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            #map {
                height: 400px;
            }
            
            .summary-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸƒâ€â™‚ï¸ æˆ‘çš„æˆ·å¤–è½¨è¿¹</h1>
        <p>è®°å½•æ¯ä¸€æ¬¡å¥”è·‘çš„è¶³è¿¹</p>
        <a href="https://zhucy-99.github.io/academicpage/" class="back-link">â† è¿”å›ä¸»é¡µ</a>
    </div>
    
    <div class="map-container">
        <div id="map"></div>
    </div>
    
    <div class="info-panel">
        <h3>è½¨è¿¹ä¿¡æ¯</h3>
        <div class="status" id="status">æ­£åœ¨åŠ è½½åœ°å›¾...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        <div id="loading-details"></div>
        
        <div class="legend" id="legend" style="display: none;">
            <h4>ğŸ¨ è½¨è¿¹é¢œè‰²è¯´æ˜</h4>
            <p>é¢œè‰²æ ¹æ®è½¨è¿¹é•¿åº¦è¿›è¡Œæ¸å˜ï¼š</p>
            <div class="color-bar"></div>
            <div class="color-labels">
                <span>çŸ­è·ç¦»</span>
                <span>ä¸­ç­‰è·ç¦»</span>
                <span>é•¿è·ç¦»</span>
            </div>
        </div>
        
        <div id="summary-stats"></div>
    </div>
    
    <!-- å¼•å…¥Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- å¼•å…¥GPXæ’ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
    
    <script>
        let map;
        let allTracks = [];
        let trackGroup;
        
        // GPXæ–‡ä»¶åˆ—è¡¨
        const gpxFiles = [
            '20241201not_outdoor_run_class_0.gpx',
            '20250124not_outdoor_run_class_0.gpx',
            '20250130not_outdoor_run_class_0.gpx',
            '20250306not_outdoor_run_class_0.gpx',
            '20250307not_outdoor_run_class_0.gpx',
            '20250308not_outdoor_run_class_0.gpx',
            '20250309not_outdoor_run_class_0.gpx',
            '20250310not_outdoor_run_class_0.gpx',
            '20250310not_outdoor_run_class_1.gpx',
            '20250311not_outdoor_run_class_0.gpx',
            '20250312not_outdoor_run_class_0.gpx',
            '20250316not_outdoor_run_class_0.gpx',
            '20250317not_outdoor_run_class_0.gpx',
            '20250318not_outdoor_run_class_0.gpx',
            '20250318not_outdoor_run_class_1.gpx',
            '20250319not_outdoor_run_class_0.gpx',
            '20250320not_outdoor_run_class_0.gpx',
            '20250320not_outdoor_run_class_1.gpx',
            '20250321not_outdoor_run_class_0.gpx',
            '20250322not_outdoor_run_class_0.gpx',
            '20250323not_outdoor_run_class_0.gpx',
            '20250324not_outdoor_run_class_0.gpx',
            '20250325not_outdoor_run_class_0.gpx',
            '20250325not_outdoor_run_class_1.gpx',
            '20250326not_outdoor_run_class_0.gpx',
            '20250327not_outdoor_run_class_0.gpx',
            '20250328not_outdoor_run_class_0.gpx',
            '20250329not_outdoor_run_class_0.gpx',
            '20250330not_outdoor_run_class_0.gpx',
            '20250331outdoor_run_class_0.gpx',
            '20250331outdoor_run_class_1.gpx',
            '20250401not_outdoor_run_class_0.gpx',
            '20250402not_outdoor_run_class_0.gpx',
            '20250403not_outdoor_run_class_0.gpx',
            '20250404not_outdoor_run_class_0.gpx',
            '20250406not_outdoor_run_class_0.gpx',
            '20250407not_outdoor_run_class_0.gpx',
            '20250408not_outdoor_run_class_0.gpx',
            '20250409not_outdoor_run_class_0.gpx',
            '20250410not_outdoor_run_class_0.gpx',
            '20250411not_outdoor_run_class_0.gpx',
            '20250414not_outdoor_run_class_0.gpx',
            '20250416not_outdoor_run_class_0.gpx',
            '20250416not_outdoor_run_class_1.gpx',
            '20250417not_outdoor_run_class_0.gpx',
            '20250419not_outdoor_run_class_0.gpx',
            '20250424not_outdoor_run_class_0.gpx',
            '20250425not_outdoor_run_class_0.gpx',
            '20250425not_outdoor_run_class_1.gpx',
            '20250426not_outdoor_run_class_0.gpx',
            '20250427not_outdoor_run_class_0.gpx',
            '20250428not_outdoor_run_class_0.gpx',
            '20250429not_outdoor_run_class_0.gpx',
            '20250430not_outdoor_run_class_0.gpx',
            '20250501not_outdoor_run_class_0.gpx',
            '20250502not_outdoor_run_class_0.gpx',
            '20250503not_outdoor_run_class_0.gpx',
            '20250504not_outdoor_run_class_0.gpx',
            '20250507not_outdoor_run_class_0.gpx',
            '20250508not_outdoor_run_class_0.gpx',
            '20250517not_outdoor_run_class_0.gpx',
            '20250517not_outdoor_run_class_1.gpx',
            '20250518not_outdoor_run_class_0.gpx',
            '20250523not_outdoor_run_class_0.gpx',
            '20250523not_outdoor_run_class_1.gpx',
            '20250523not_outdoor_run_class_2.gpx',
            '20250526not_outdoor_run_class_0.gpx',
            '20250531not_outdoor_run_class_0.gpx',
            '20250531not_outdoor_run_class_1.gpx',
            '20250531not_outdoor_run_class_2.gpx',
            '20250531not_outdoor_run_class_3.gpx',
            '20250601not_outdoor_run_class_0.gpx',
            '20250601not_outdoor_run_class_1.gpx',
            '20250602not_outdoor_run_class_0.gpx',
            '20250607outdoor_run_class_0.gpx',
            '20250611not_outdoor_run_class_0.gpx',
            '20250615not_outdoor_run_class_0.gpx',
            '20250615not_outdoor_run_class_1.gpx',
            '20250623not_outdoor_run_class_0.gpx',
            '20250623not_outdoor_run_class_1.gpx',
            '20250624not_outdoor_run_class_0.gpx',
            '20250625not_outdoor_run_class_0.gpx',
            '20250628not_outdoor_run_class_0.gpx',
            '20250701not_outdoor_run_class_0.gpx',
            '20250702not_outdoor_run_class_0.gpx',
            '20250703not_outdoor_run_class_0.gpx',
            '20250705not_outdoor_run_class_0.gpx',
            '20250706not_outdoor_run_class_0.gpx',
            '20250707not_outdoor_run_class_0.gpx',
            '20250707not_outdoor_run_class_1.gpx',
            '20250709not_outdoor_run_class_0.gpx',
            '20250710not_outdoor_run_class_0.gpx',
            '20250711not_outdoor_run_class_0.gpx',
            '20250713not_outdoor_run_class_0.gpx',
            '20250714not_outdoor_run_class_0.gpx',
            '20250716not_outdoor_run_class_0.gpx',
            '20250719not_outdoor_run_class_0.gpx',
            '20250720not_outdoor_run_class_0.gpx',
            '20250723not_outdoor_run_class_0.gpx',
            '20250725not_outdoor_run_class_0.gpx',
            '20250727outdoor_run_class_0.gpx',
            '20250731not_outdoor_run_class_0.gpx',
            '20250801not_outdoor_run_class_0.gpx',
            '20250804not_outdoor_run_class_0.gpx',
            '20250804not_outdoor_run_class_1.gpx',
            '20250810not_outdoor_run_class_0.gpx',
            '20250810not_outdoor_run_class_1.gpx',
            '20250811not_outdoor_run_class_0.gpx',
            '20250814not_outdoor_run_class_0.gpx'
        ];
        
        function updateStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            console.log(message);
            statusDiv.innerHTML = message;
            if (isError) {
                statusDiv.className = 'status error';
            } else {
                statusDiv.className = 'status';
            }
        }
        
        function updateProgress(current, total) {
            const progressBar = document.getElementById('progress');
            const percentage = (current / total) * 100;
            progressBar.style.width = percentage + '%';
            
            document.getElementById('loading-details').innerHTML = `
                <div style="text-align: center; color: #666;">
                    æ­£åœ¨åŠ è½½: ${current}/${total} (${percentage.toFixed(1)}%)
                </div>
            `;
        }
        
        // æ ¹æ®è·ç¦»è·å–é¢œè‰²çš„å‡½æ•°
        function getColorByDistance(distance, minDist, maxDist) {
            // å½’ä¸€åŒ–è·ç¦»åˆ°0-1åŒºé—´
            const normalized = (distance - minDist) / (maxDist - minDist);
            
            // å®šä¹‰é¢œè‰²æ¢¯åº¦ (ä»è“è‰²åˆ°çº¢è‰²)
            const colors = [
                { r: 46, g: 134, b: 171 },   // è“è‰² - çŸ­è·ç¦»
                { r: 162, g: 59, b: 114 },   // ç´«è‰²
                { r: 241, g: 143, b: 1 },    // æ©™è‰²
                { r: 199, g: 62, b: 29 },    // çº¢æ©™è‰²
                { r: 139, g: 0, b: 0 }       // æ·±çº¢è‰² - é•¿è·ç¦»
            ];
            
            // æ ¹æ®å½’ä¸€åŒ–å€¼é€‰æ‹©é¢œè‰²
            const colorIndex = Math.min(Math.floor(normalized * (colors.length - 1)), colors.length - 2);
            const localNormalized = (normalized * (colors.length - 1)) - colorIndex;
            
            const color1 = colors[colorIndex];
            const color2 = colors[colorIndex + 1];
            
            // çº¿æ€§æ’å€¼
            const r = Math.round(color1.r + (color2.r - color1.r) * localNormalized);
            const g = Math.round(color1.g + (color2.g - color1.g) * localNormalized);
            const b = Math.round(color1.b + (color2.b - color1.b) * localNormalized);
            
            return `rgb(${r}, ${g}, ${b})`;
        }
        
        function initMap() {
            updateStatus('ğŸ—ºï¸ æ­£åœ¨åˆå§‹åŒ–åœ°å›¾...');
            
            try {
                // åˆ›å»ºåœ°å›¾å®ä¾‹
                map = L.map('map').setView([39.9042, 116.4074], 13);
                
                // æ·»åŠ  OpenStreetMapå›¾å±‚
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // æ·»åŠ æ¯”ä¾‹å°º
                L.control.scale().addTo(map);
                
                // åˆ›å»ºå›¾å±‚ç»„ç”¨äºç®¡ç†æ‰€æœ‰è½¨è¿¹
                trackGroup = L.featureGroup().addTo(map);
                
                updateStatus('âœ… åŸºç¡€åœ°å›¾åŠ è½½æˆåŠŸï¼æ­£åœ¨åŠ è½½GPXè½¨è¿¹...');
                
                // åŠ è½½æ‰€æœ‰GPXæ–‡ä»¶
                loadAllGPXTracks();
                
            } catch (error) {
                updateStatus('âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥: ' + error.message, true);
                console.error('Map initialization error:', error);
            }
        }
        
        function loadAllGPXTracks() {
            let loadedCount = 0;
            let successCount = 0;
            const totalFiles = gpxFiles.length;
            const trackDistances = [];
            
            updateProgress(0, totalFiles);
            
            // ç¬¬ä¸€éåŠ è½½ï¼šæ”¶é›†æ‰€æœ‰è½¨è¿¹çš„è·ç¦»ä¿¡æ¯
            const firstPassPromises = gpxFiles.map((filename, index) => {
                return new Promise((resolve) => {
                    const gpxUrl = `https://zhucy-99.github.io/academicpage/gpx/${filename}`;
                    
                    const gpx = new L.GPX(gpxUrl, {
                        async: true,
                        marker_options: {
                            startIcon: null,  // ç¦ç”¨èµ·ç‚¹æ ‡è®°
                            endIcon: null,    // ç¦ç”¨ç»ˆç‚¹æ ‡è®°
                        },
                        polyline_options: {
                            weight: 3,
                            opacity: 0.8,
                            smoothFactor: 1.0
                        }
                    });
                    
                    gpx.on('loaded', function(e) {
                        const distance = this.get_distance() / 1000; // è½¬æ¢ä¸ºå…¬é‡Œ
                        trackDistances.push({
                            index: index,
                            filename: filename,
                            distance: distance,
                            gpx: this
                        });
                        
                        loadedCount++;
                        successCount++;
                        updateProgress(loadedCount, totalFiles);
                        resolve();
                    });
                    
                    gpx.on('error', function(e) {
                        console.warn(`Failed to load ${filename}:`, e);
                        loadedCount++;
                        updateProgress(loadedCount, totalFiles);
                        resolve();
                    });
                    
                    // è®¾ç½®è¶…æ—¶
                    setTimeout(() => {
                        if (loadedCount === index) {
                            loadedCount++;
                            updateProgress(loadedCount, totalFiles);
                            resolve();
                        }
                    }, 10000);
                });
            });
            
            // ç­‰å¾…æ‰€æœ‰æ–‡ä»¶åŠ è½½å®Œæˆ
            Promise.all(firstPassPromises).then(() => {
                if (trackDistances.length === 0) {
                    updateStatus('âŒ æ²¡æœ‰æˆåŠŸåŠ è½½ä»»ä½•GPXè½¨è¿¹', true);
                    return;
                }
                
                // è®¡ç®—è·ç¦»çš„æœ€å°å€¼å’Œæœ€å¤§å€¼
                const distances = trackDistances.map(t => t.distance);
                const minDistance = Math.min(...distances);
                const maxDistance = Math.max(...distances);
                
                updateStatus(`ğŸ¨ æ­£åœ¨åº”ç”¨é¢œè‰²æ¸å˜... (${successCount}/${totalFiles} è½¨è¿¹åŠ è½½æˆåŠŸ)`);
                
                // ç¬¬äºŒéï¼šæ ¹æ®è·ç¦»è®¾ç½®é¢œè‰²å¹¶æ·»åŠ åˆ°åœ°å›¾
                trackDistances.forEach(track => {
                    const color = getColorByDistance(track.distance, minDistance, maxDistance);
                    
                    // æ›´æ–°è½¨è¿¹é¢œè‰²
                    track.gpx.eachLayer(function(layer) {
                        if (layer instanceof L.Polyline) {
                            layer.setStyle({ color: color });
                        }
                    });
                    
                    // æ·»åŠ å¼¹å‡ºçª—å£
                    const duration = track.gpx.get_duration_string();
                    const avgPace = track.distance > 0 ? (track.gpx.get_duration() / 60 / track.distance).toFixed(2) : 'æœªçŸ¥';
                    const date = track.filename.substring(0, 8);
                    const formattedDate = `${date.substring(0,4)}-${date.substring(4,6)}-${date.substring(6,8)}`;
                    
                    track.gpx.bindPopup(`
                        <div style="text-align: center; min-width: 200px;">
                            <h4 style="margin: 0 0 10px 0; color: ${color};">ğŸƒâ€â™‚ï¸ ${track.filename.includes('outdoor') ? 'æˆ·å¤–è·‘æ­¥' : 'å®¤å†…è·‘æ­¥'}</h4>
                            <p><strong>æ—¥æœŸ:</strong> ${formattedDate}</p>
                            <p><strong>è·ç¦»:</strong> ${track.distance.toFixed(2)} km</p>
                            <p><strong>ç”¨æ—¶:</strong> ${duration}</p>
                            <p><strong>å¹³å‡é…é€Ÿ:</strong> ${avgPace} min/km</p>
                        </div>
                    `);
                    
                    // æ·»åŠ åˆ°å›¾å±‚ç»„
                    trackGroup.addLayer(track.gpx);
                    allTracks.push(track);
                });
                
                // è°ƒæ•´åœ°å›¾è§†å›¾åˆ°æ‰€æœ‰è½¨è¿¹
                if (trackGroup.getLayers().length > 0) {
                    map.fitBounds(trackGroup.getBounds(), {
                        padding: [20, 20]
                    });
                }
                
                // æ˜¾ç¤ºå›¾ä¾‹
                document.getElementById('legend').style.display = 'block';
                
                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                displaySummaryStats(trackDistances, minDistance, maxDistance);
                
                updateStatus(`ğŸ‰ æˆåŠŸåŠ è½½ ${successCount} æ¡è½¨è¿¹ï¼`);
            });
        }
        
        function displaySummaryStats(tracks, minDistance, maxDistance) {
            const totalDistance = tracks.reduce((sum, track) => sum + track.distance, 0);
            const avgDistance = totalDistance / tracks.length;
            const outdoorTracks = tracks.filter(t => t.filename.includes('outdoor')).length;
            const indoorTracks = tracks.length - outdoorTracks;
            
            document.getElementById('summary-stats').innerHTML = `
                <div class="summary-stats">
                    <div class="stat-item">
                        <strong>${tracks.length}</strong><br>
                        <span>æ€»è½¨è¿¹æ•°</span>
                    </div>
                    <div class="stat-item">
                        <strong>${totalDistance.toFixed(1)} km</strong><br>
                        <span>æ€»è·ç¦»</span>
                    </div>
                    <div class="stat-item">
                        <strong>${avgDistance.toFixed(2)} km</strong><br>
                        <span>å¹³å‡è·ç¦»</span>
                    </div>
                    <div class="stat-item">
                        <strong>${outdoorTracks}</strong><br>
                        <span>æˆ·å¤–è·‘æ­¥</span>
                    </div>
                    <div class="stat-item">
                        <strong>${indoorTracks}</strong><br>
                        <span>å®¤å†…è·‘æ­¥</span>
                    </div>
                    <div class="stat-item">
                        <strong>${minDistance.toFixed(2)} - ${maxDistance.toFixed(2)} km</strong><br>
                        <span>è·ç¦»èŒƒå›´</span>
                    </div>
                </div>
            `;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åœ°å›¾
        window.addEventListener('load', function() {
            // ç¨å¾®å»¶è¿Ÿä»¥ç¡®ä¿æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆ
            setTimeout(initMap, 500);
        });
        
        // å¤‡ç”¨åˆå§‹åŒ–æ–¹æ³•
        document.addEventListener('DOMContentLoaded', function() {
            if (document.readyState === 'complete') {
                setTimeout(initMap, 1000);
            }
        });
    </script>
</body>
</html>
