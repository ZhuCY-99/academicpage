<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊàëÁöÑÊà∑Â§ñËΩ®ËøπÈõÜÂêà - Auto Scan Version</title>
    
    <!-- ÂºïÂÖ•Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        .back-link {
            display: inline-block;
            margin: 15px 0;
            padding: 12px 24px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: background 0.3s;
            font-weight: 500;
        }
        
        .back-link:hover {
            background: #2980b9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .map-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        #map {
            height: 650px;
            width: 100%;
        }
        
        .controls h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .scan-section {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6c3;
        }
        
        .scan-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            resize: vertical;
            min-height: 100px;
        }
        
        .scan-button {
            width: 100%;
            padding: 10px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: 500;
        }
        
        .scan-button:hover {
            background: #229954;
        }
        
        .scan-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .control-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .show-all { background: #27ae60; color: white; }
        .hide-all { background: #e74c3c; color: white; }
        .fit-bounds { background: #f39c12; color: white; }
        .reload-btn { background: #9b59b6; color: white; }
        
        .control-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        .status {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-weight: 500;
            background: #e8f4fd;
            color: #2980b9;
            border: 1px solid #bde4f4;
        }
        
        .status.error {
            background: #fdf2f2;
            color: #e74c3c;
            border-color: #fecaca;
        }
        
        .status.success {
            background: #f0fff4;
            color: #16a085;
            border-color: #a7f3d0;
        }
        
        .status.warning {
            background: #fffbf0;
            color: #d68910;
            border-color: #f7dc6f;
        }
        
        .track-list {
            max-height: 450px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
        }
        
        .track-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 6px 0;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .track-item:hover {
            background: #e9ecef;
            transform: translateX(3px);
        }
        
        .track-item.loading {
            opacity: 0.7;
            border-left-color: #ffc107;
            animation: pulse 1.5s ease-in-out infinite alternate;
        }
        
        .track-item.loaded {
            border-left-color: #28a745;
        }
        
        .track-item.error {
            border-left-color: #dc3545;
            opacity: 0.6;
        }
        
        @keyframes pulse {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }
        
        .track-checkbox {
            margin-right: 12px;
            transform: scale(1.1);
        }
        
        .track-info {
            flex: 1;
        }
        
        .track-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
            font-size: 0.95em;
        }
        
        .track-details {
            font-size: 0.8em;
            color: #6c757d;
            line-height: 1.3;
        }
        
        .color-legend {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .legend-gradient {
            height: 20px;
            background: linear-gradient(90deg, #2ecc71, #f1c40f, #e67e22, #e74c3c, #8b0000);
            border-radius: 4px;
            margin: 8px 0;
        }
        
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #666;
        }
        
        .summary-stats {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        
        .summary-stats h4 {
            margin: 0 0 10px 0;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 4px;
        }
        
        .help-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
                order: 2;
            }
            
            .map-container {
                order: 1;
            }
            
            #map {
                height: 500px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .control-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è ÊàëÁöÑÊà∑Â§ñËΩ®ËøπÈõÜÂêà</h1>
        <p>Ëá™Âä®Êâ´ÊèèÂπ∂ÂèØËßÜÂåñÊâÄÊúâGPXËΩ®ËøπÊñá‰ª∂</p>
        <a href="https://zhucy-99.github.io/academicpage/" class="back-link">‚Üê ËøîÂõû‰∏ªÈ°µ</a>
    </div>
    
    <div class="main-content">
        <div class="sidebar">
            <div class="controls">
                <h3>üîç Êñá‰ª∂Êâ´Êèè</h3>
                
                <div class="scan-section">
                    <label for="file-list" style="font-weight: 500; color: #2c3e50;">GPXÊñá‰ª∂ÂàóË°®Ôºö</label>
                    <textarea id="file-list" class="scan-input" placeholder="Âú®ËøôÈáåÁ≤òË¥¥GPXÊñá‰ª∂ÂêçÂàóË°®ÔºåÊØèË°å‰∏Ä‰∏™Êñá‰ª∂Âêç„ÄÇ&#10;‰æãÂ¶ÇÔºö&#10;20241201not_outdoor_run_class_0.gpx&#10;20241202morning_run.gpx&#10;20241203evening_cycle.gpx&#10;&#10;ÊàñËÄÖÁÇπÂáª‰∏ãÈù¢ÁöÑÊåâÈíÆËá™Âä®Â∞ùËØïÂ∏∏ËßÅÊñá‰ª∂Âêç..."></textarea>
                    <button id="scan-button" class="scan-button">üöÄ Âä†ËΩΩËΩ®ËøπÊñá‰ª∂</button>
                    <button id="auto-scan-button" class="scan-button" style="background: #e67e22; margin-top: 5px;">üéØ Êô∫ËÉΩÊâ´ÊèèÂ∏∏ËßÅÊñá‰ª∂Âêç</button>
                    
                    <div class="help-text">
                        <strong>üí° ‰ΩøÁî®ÊèêÁ§∫Ôºö</strong><br>
                        ‚Ä¢ ÂèØ‰ª•ÊâãÂä®ËæìÂÖ•Êñá‰ª∂ÂêçÔºå‰πüÂèØ‰ª•‰ΩøÁî®Êô∫ËÉΩÊâ´Êèè<br>
                        ‚Ä¢ Êô∫ËÉΩÊâ´Êèè‰ºöÂ∞ùËØïÂ∏∏ËßÅÁöÑÊñá‰ª∂ÂëΩÂêçÊ®°Âºè<br>
                        ‚Ä¢ Êñá‰ª∂ÂêçÈúÄË¶ÅÂåÖÂê´ .gpx ÂêéÁºÄ
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button class="control-btn show-all" onclick="showAllTracks()">ÊòæÁ§∫ÂÖ®ÈÉ®</button>
                    <button class="control-btn hide-all" onclick="hideAllTracks()">ÈöêËóèÂÖ®ÈÉ®</button>
                    <button class="control-btn fit-bounds" onclick="fitAllBounds()">ÈÄÇÂ∫îËßÜÂõæ</button>
                    <button class="control-btn reload-btn" onclick="clearAndReload()">ÈáçÊñ∞Êâ´Êèè</button>
                </div>
                
                <div class="status" id="status">ÁÇπÂáª‰∏äÈù¢ÁöÑÊåâÈíÆÂºÄÂßãÂä†ËΩΩËΩ®Ëøπ</div>
                
                <div class="track-list" id="track-list">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        üìÅ ÊöÇÊó†ËΩ®ËøπÊñá‰ª∂<br>
                        ËØ∑ÂÖàÊ∑ªÂä†Êñá‰ª∂ÂêçÂπ∂ÁÇπÂáªÂä†ËΩΩ
                    </div>
                </div>
                
                <div class="color-legend" style="display: none;" id="color-legend">
                    <div class="legend-title">üé® Ë∑ùÁ¶ªÈÖçËâ≤ËØ¥Êòé</div>
                    <div class="legend-gradient"></div>
                    <div class="legend-labels">
                        <span>Áü≠</span>
                        <span>‰∏≠Á≠â</span>
                        <span>ËæÉÈïø</span>
                        <span>Èïø</span>
                        <span>Ë∂ÖÈïø</span>
                    </div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        ËΩ®ËøπÊåâË∑ùÁ¶ªËá™Âä®ÈÖçËâ≤ÔºåÁ∫¢Ëâ≤Ë°®Á§∫Êõ¥ÈïøË∑ùÁ¶ª
                    </div>
                </div>
                
                <div class="summary-stats" id="summary-stats" style="display: none;">
                    <h4>üìä ÁªüËÆ°Ê±áÊÄª</h4>
                    <div class="stats-grid" id="stats-content"></div>
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>
    
    <!-- ÂºïÂÖ•Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- ÂºïÂÖ•GPXÊèí‰ª∂ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
    
    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let map;
        let trackLayers = [];
        let allBounds = null;
        let loadedTracksCount = 0;
        let totalStats = {
            distance: 0,
            duration: 0,
            elevationGain: 0,
            tracksCount: 0
        };
        let currentGPXFiles = [];
        
        // Â∏∏ËßÅÁöÑGPXÊñá‰ª∂ÂêçÊ®°Âºè
        const COMMON_PATTERNS = [
            // Êó•ÊúüÊ†ºÂºèÁöÑÊñá‰ª∂Âêç
            ...generateDatePatterns(),
            // Â∏∏ËßÅÁöÑËøêÂä®Á±ªÂûãÊñá‰ª∂Âêç
            'morning_run.gpx', 'evening_run.gpx', 'weekend_run.gpx',
            'cycling.gpx', 'bike_ride.gpx', 'cycling_route.gpx',
            'hiking.gpx', 'hike.gpx', 'mountain_hike.gpx',
            'walking.gpx', 'walk.gpx', 'daily_walk.gpx',
            // Â∏¶ÁºñÂè∑ÁöÑÊñá‰ª∂Âêç
            ...Array.from({length: 20}, (_, i) => `track_${i + 1}.gpx`),
            ...Array.from({length: 10}, (_, i) => `route_${i + 1}.gpx`),
            ...Array.from({length: 10}, (_, i) => `activity_${i + 1}.gpx`),
            // StravaÁ≠âÂ∫îÁî®Â∏∏ËßÅÊ†ºÂºè
            ...Array.from({length: 10}, (_, i) => `Activity_${Date.now() - i * 86400000}.gpx`),
        ];
        
        // ÁîüÊàêÊó•ÊúüÊ®°ÂºèÁöÑÊñá‰ª∂ÂêçÔºàÊúÄËøë3‰∏™ÊúàÔºâ
        function generateDatePatterns() {
            const patterns = [];
            const today = new Date();
            
            for (let i = 0; i < 90; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                // ÂêÑÁßçÊó•ÊúüÊ†ºÂºè
                patterns.push(`${year}${month}${day}_run.gpx`);
                patterns.push(`${year}${month}${day}_outdoor_run.gpx`);
                patterns.push(`${year}${month}${day}not_outdoor_run_class_0.gpx`);
                patterns.push(`${year}-${month}-${day}_activity.gpx`);
                patterns.push(`${year}_${month}_${day}.gpx`);
            }
            
            return patterns;
        }
        
        // Ê†πÊçÆË∑ùÁ¶ªÁîüÊàêÈ¢úËâ≤
        function getColorByDistance(distance, minDist, maxDist) {
            if (maxDist === minDist) return '#e74c3c';
            
            const normalized = (distance - minDist) / (maxDist - minDist);
            
            if (normalized < 0.25) {
                const t = normalized * 4;
                return `rgb(${Math.round(46 + t * (241-46))}, ${Math.round(204 + t * (196-204))}, 113)`;
            } else if (normalized < 0.5) {
                const t = (normalized - 0.25) * 4;
                return `rgb(${Math.round(241 + t * (230-241))}, ${Math.round(196 + t * (126-196))}, ${Math.round(113 + t * (34-113))})`;
            } else if (normalized < 0.75) {
                const t = (normalized - 0.5) * 4;
                return `rgb(${Math.round(230 + t * (231-230))}, ${Math.round(126 + t * (76-126))}, ${Math.round(34 + t * (60-34))})`;
            } else {
                const t = (normalized - 0.75) * 4;
                return `rgb(${Math.round(231 + t * (139-231))}, ${Math.round(76 * (1-t))}, ${Math.round(60 * (1-t))})`;
            }
        }
        
        // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            console.log(message);
        }
        
        // ÂàùÂßãÂåñÂú∞Âõæ
        function initMap() {
            try {
                // ÂàõÂª∫Âú∞ÂõæÂÆû‰æã
                map = L.map('map').setView([39.9042, 116.4074], 13);
                
                // Ê∑ªÂä†Â§ö‰∏™ÂõæÂ±ÇÈÄâÈ°π
                const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap contributors'
                });
                
                const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles ¬© Esri'
                });
                
                const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data: ¬© OpenStreetMap contributors, SRTM | Map style: ¬© OpenTopoMap'
                });
                
                // ÈªòËÆ§Ê∑ªÂä†OSMÂõæÂ±Ç
                osmLayer.addTo(map);
                
                // Ê∑ªÂä†ÂõæÂ±ÇÊéßÂà∂
                L.control.layers({
                    "üó∫Ô∏è Ë°óÈÅìÂú∞Âõæ": osmLayer,
                    "üõ∞Ô∏è Âç´ÊòüÂú∞Âõæ": satelliteLayer,
                    "‚õ∞Ô∏è Âú∞ÂΩ¢Âú∞Âõæ": topoLayer
                }).addTo(map);
                
                // Ê∑ªÂä†ÊØî‰æãÂ∞∫
                L.control.scale().addTo(map);
                
                updateStatus('‚úÖ Âú∞ÂõæÂàùÂßãÂåñÂÆåÊàêÔºåËØ∑ËæìÂÖ•GPXÊñá‰ª∂ÂêçÂπ∂ÂºÄÂßãÂä†ËΩΩ', 'success');
                
            } catch (error) {
                updateStatus(`‚ùå Âú∞ÂõæÂàùÂßãÂåñÂ§±Ë¥•: ${error.message}`, 'error');
                console.error('Map initialization error:', error);
            }
        }
        
        // Ëß£ÊûêÊñá‰ª∂ÂêçÂàóË°®
        function parseFileList(text) {
            return text
                .split(/[\r\n]+/)
                .map(line => line.trim())
                .filter(line => line && line.endsWith('.gpx'))
                .map(line => line.replace(/^[‚Ä¢\-\*]\s*/, '')); // ÁßªÈô§ÂèØËÉΩÁöÑÂàóË°®Á¨¶Âè∑
        }
        
        // Âä†ËΩΩGPXÊñá‰ª∂
        function loadGPXFiles(gpxFiles) {
            if (gpxFiles.length === 0) {
                updateStatus('‚ö†Ô∏è Ê≤°ÊúâÊâæÂà∞ÊúâÊïàÁöÑGPXÊñá‰ª∂Âêç', 'warning');
                return;
            }
            
            currentGPXFiles = gpxFiles;
            updateStatus(`üìÇ ÂºÄÂßãÂä†ËΩΩ ${gpxFiles.length} ‰∏™ËΩ®ËøπÊñá‰ª∂...`);
            
            // ÈáçÁΩÆÁªüËÆ°
            totalStats = { distance: 0, duration: 0, elevationGain: 0, tracksCount: 0 };
            trackLayers = [];
            loadedTracksCount = 0;
            allBounds = null;
            
            // ÂàõÂª∫ËΩ®ËøπÂàóË°®UI
            createTrackList(gpxFiles);
            
            // ÈöêËóèÂõæ‰æãÂíåÁªüËÆ°
            document.getElementById('color-legend').style.display = 'none';
            document.getElementById('summary-stats').style.display = 'none';
            
            // Áî®‰∫éËÆ°ÁÆóË∑ùÁ¶ªËåÉÂõ¥
            let tempDistances = [];
            let tempLoadedCount = 0;
            let validFilesCount = 0;
            
            // È¶ñÂÖàÂ∞ùËØïÂä†ËΩΩÊâÄÊúâÊñá‰ª∂
            gpxFiles.forEach((filename, index) => {
                const gpxUrl = `https://zhucy-99.github.io/academicpage/gpx/${filename}`;
                
                const gpx = new L.GPX(gpxUrl, {
                    async: true,
                    marker_options: { startIconUrl: null, endIconUrl: null, shadowUrl: null },
                    polyline_options: { color: '#cccccc', weight: 3, opacity: 0.7 }
                });
                
                gpx.on('loaded', function(e) {
                    const distance = this.get_distance() / 1000;
                    tempDistances.push({ index, distance, gpx: this, filename });
                    tempLoadedCount++;
                    validFilesCount++;
                    
                    updateTrackItem(index, 'loading', `Â∑≤Âä†ËΩΩ - ${distance.toFixed(2)}km`);
                    
                    // ÂΩìÊâÄÊúâÊúâÊïàÊñá‰ª∂ÈÉΩÂä†ËΩΩÂÆåÊàêÂêéÔºåÂ∫îÁî®ÈÖçËâ≤
                    if (tempLoadedCount === validFilesCount) {
                        setTimeout(() => applyColorsByDistance(tempDistances), 500);
                    }
                });
                
                gpx.on('error', function(e) {
                    console.warn(`Failed to load ${filename}:`, e);
                    updateTrackItem(index, 'error', 'Êñá‰ª∂‰∏çÂ≠òÂú®ÊàñÊó†Ê≥ïÂä†ËΩΩ');
                    tempLoadedCount++;
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÊñá‰ª∂ÈÉΩÂ∑≤Â∞ùËØïÂä†ËΩΩ
                    if (tempLoadedCount === gpxFiles.length && validFilesCount > 0) {
                        setTimeout(() => applyColorsByDistance(tempDistances), 500);
                    } else if (tempLoadedCount === gpxFiles.length && validFilesCount === 0) {
                        updateStatus('‚ùå Ê≤°ÊúâÊàêÂäüÂä†ËΩΩ‰ªª‰ΩïGPXÊñá‰ª∂', 'error');
                    }
                });
                
                trackLayers[index] = gpx;
                updateTrackItem(index, 'loading', 'Ê≠£Âú®Âä†ËΩΩ...');
            });
            
            // ËÆæÁΩÆË∂ÖÊó∂Ê£ÄÊü•
            setTimeout(() => {
                if (validFilesCount === 0) {
                    updateStatus(`‚ö†Ô∏è Â∞ùËØï‰∫Ü ${gpxFiles.length} ‰∏™Êñá‰ª∂Ôºå‰ΩÜÊ≤°ÊúâÊâæÂà∞ÊúâÊïàÁöÑGPXÊñá‰ª∂`, 'warning');
                }
            }, 10000);
        }
        
        // Â∫îÁî®ÊåâË∑ùÁ¶ªÈÖçËâ≤
        function applyColorsByDistance(distanceData) {
            if (distanceData.length === 0) return;
            
            const distances = distanceData.map(d => d.distance);
            const minDist = Math.min(...distances);
            const maxDist = Math.max(...distances);
            
            updateStatus(`üé® ‰∏∫ ${distanceData.length} Êù°ËΩ®ËøπÂ∫îÁî®ÈÖçËâ≤ (${minDist.toFixed(2)}-${maxDist.toFixed(2)}km)`);
            
            // ÊåâË∑ùÁ¶ªÊéíÂ∫è
            distanceData.sort((a, b) => b.distance - a.distance);
            
            // ÈáçÊñ∞ÊéíÂ∫èËΩ®ËøπÂàóË°®
            reorderTrackList(distanceData);
            
            allBounds = L.latLngBounds();
            
            distanceData.forEach(({ index, distance, gpx, filename }) => {
                const color = getColorByDistance(distance, minDist, maxDist);
                
                // Êõ¥Êñ∞Ê†∑ÂºèÂπ∂Ê∑ªÂä†Âà∞Âú∞Âõæ
                gpx.setStyle({ color: color, weight: 4, opacity: 0.8 });
                gpx.addTo(map);
                
                allBounds.extend(gpx.getBounds());
                
                // Êõ¥Êñ∞ÁªüËÆ°
                const duration = gpx.get_duration();
                const elevationGain = gpx.get_elevation_gain();
                
                totalStats.distance += distance;
                totalStats.duration += duration;
                totalStats.elevationGain += elevationGain;
                totalStats.tracksCount++;
                
                // Ê∑ªÂä†ÂºπÁ™ó
                gpx.bindPopup(`
                    <div style="text-align: center; min-width: 220px;">
                        <h4 style="margin: 0 0 10px 0; color: ${color};">üèÉ‚Äç‚ôÇÔ∏è ${filename}</h4>
                        <p><strong>Ë∑ùÁ¶ª:</strong> ${distance.toFixed(2)} km</p>
                        <p><strong>Áî®Êó∂:</strong> ${gpx.get_duration_string()}</p>
                        <p><strong>Áà¨Âçá:</strong> ${elevationGain.toFixed(0)} m</p>
                        <p><strong>Âπ≥ÂùáÈÖçÈÄü:</strong> ${duration > 0 && distance > 0 ? 
                            (duration / 60 / distance).toFixed(2) + ' min/km' : 'Êú™Áü•'}</p>
                        <p style="font-size: 0.9em; color: #666;">ÁÇπÂáªËΩ®ËøπÂêçÁß∞ÂèØÂø´ÈÄüÂÆö‰Ωç</p>
                    </div>
                `);
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                const durationStr = gpx.get_duration_string();
                updateTrackItem(index, 'loaded', `${distance.toFixed(2)}km ¬∑ ${durationStr}`, color);
                
                loadedTracksCount++;
            });
            
            // ÂÆåÊàêÂä†ËΩΩ
            finishLoading();
        }
        
        // ÂàõÂª∫ËΩ®ËøπÂàóË°®UI
        function createTrackList(gpxFiles) {
            const trackList = document.getElementById('track-list');
            trackList.innerHTML = '';
            
            gpxFiles.forEach((filename, index) => {
                const trackItem = document.createElement('div');
                trackItem.className = 'track-item';
                trackItem.id = `track-${index}`;
                
                trackItem.innerHTML = `
                    <input type="checkbox" class="track-checkbox" checked data-index="${index}">
                    <div class="track-info">
                        <div class="track-name">${filename}</div>
                        <div class="track-details">ÂáÜÂ§áÂä†ËΩΩ...</div>
                    </div>
                `;
                
                // Ê∑ªÂä†Â§çÈÄâÊ°Ü‰∫ã‰ª∂
                const checkbox = trackItem.querySelector('.track-checkbox');
                checkbox.addEventListener('change', function() {
                    const idx = parseInt(this.dataset.index);
                    if (trackLayers[idx]) {
                        if (this.checked) {
                            map.addLayer(trackLayers[idx]);
                        } else {
                            map.removeLayer(trackLayers[idx]);
                        }
                    }
                });
                
                // Ê∑ªÂä†ÁÇπÂáªÁº©Êîæ‰∫ã‰ª∂
                trackItem.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        const idx = parseInt(this.querySelector('.track-checkbox').dataset.index);
                        if (trackLayers[idx] && trackLayers[idx]._map) {
                            map.fitBounds(trackLayers[idx].getBounds(), {padding: [30, 30]});
                        }
                    }
                });
                
                trackList.appendChild(trackItem);
            });
        }
        
        // Êõ¥Êñ∞ËΩ®ËøπÈ°πÊòæÁ§∫
        function updateTrackItem(index, status, details, color = null) {
            const trackItem = document.getElementById(`track-${index}`);
            if (!trackItem) return;
            
            trackItem.className = `track-item ${status}`;
            
            if (color) {
                trackItem.style.borderLeftColor = color;
                const trackName = trackItem.querySelector('.track-name');
                trackName.style.color = color;
                trackName.style.fontWeight = '700';
            }
            
            trackItem.querySelector('.track-details').textContent = details;
        }
        
        // ÈáçÊñ∞ÊéíÂ∫èËΩ®ËøπÂàóË°®
        function
